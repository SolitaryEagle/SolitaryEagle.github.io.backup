---
layout: post
title: k8s安装教程
category: k8s
tags: k8s
---
本文将以安装 一主一从 作为示例

所有操作都使用 root 用户

# 安装环境
* 本机：
    * Linux eagle-telnet 5.4.0-42-generic #46-Ubuntu SMP Fri Jul 10 00:24:02 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux
    * Ubuntu 20.04.1 LTS
    ![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/Ubuntu.png)
* 虚拟机
    * VMware® Workstation 15 Pro
    ![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/VMware.png)
    * [CentOS 8](https://mirrors.aliyun.com/centos/8/isos/x86_64/CentOS-8.2.2004-x86_64-boot.iso)
* 安装工具
    * 本文采用 kubeadm 引导安装 k8s 集群

# 虚拟机安装 CentOS 
## CentOS 配置
> 两台一样配置的 CentOS 虚拟机（k8s-master, k8s-worker)
* 内存 4 g
* CPU 2 核，开启虚拟化功能
* 网络 NAT 类型（单网卡）
* 磁盘 120 GB
![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/CentOs1.png)
![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/CentOs2.png)
![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/CentOs3.png)
## CentOS 安装
> 两台机子的安装过程几乎一致
> 
> 主机的 HostName 为 k8s-master
>
> 从机的 HostName 为 k8s-worker

1. 选择语言：English
2. 设置时间：Asia/Shanghai
3. 设置网络：
    1. 打开网络连接
    2. 设置 Host Name：k8s-master
4. 软件选择：最小安装
5. 设置 root 密码
6. 关闭磁盘连接，重启
![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/CentOs4.png)
![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/CentOs5.png)
![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/CentOs6.png)
## Kubernetes 安装工具 安装
> 两台机子都需要执行的步骤（建议按顺序分别执行两次）
* 设置 locale
```shell script
echo "export LC_ALL=en_US.UTF-8"  >>  /etc/profile 
source /etc/profile
```
* 安装基本工具
```shell script
yum update -y && yum install -y \
  vim \
  net-tools \
  bash-completion \
  wget
```
* 设置本地 hosts
```shell script
echo -e "192.168.194.136 k8s-master \n192.168.194.137 k8s-worker" >> /etc/hosts
```
* 关闭交换分区 -- 编辑/etc/fstab, 将swap注释掉.
 ```shell script
vim /etc/fstab
```
![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/swap.png)
* 检查 Mac 地址 和 product_uuid 是否唯一
```shell script
ip link
cat /sys/class/dmi/id/product_uuid
```
* 检查 br_netfilter 模块是否加载
```shell script
# 检查 br_netfilter 模块是否加载
lsmod | grep br_netfilter
# 显式加载 br_netfilter 模块
modprobe br_netfilter
```
* 使用 iptables 作为网桥
```shell script
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sysctl --system
```
* 关闭防火墙或开放 Kubernetes 需要的端口
```shell script
# 关闭防火墙
systemctl stop firewalld
systemctl disable firewalld
```
* 重启
```shell script
reboot
```
* 安装 容器运行时 (此处选择 Docker)
```shell script
# 安装依赖
yum install -y yum-utils device-mapper-persistent-data lvm2
# 添加 Docker repository
yum-config-manager --add-repo \
  https://download.docker.com/linux/centos/docker-ce.repo
# 安装 containerd.io-1.2.13
yum update -y && yum install -y \
  https://download.docker.com/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.13-3.2.el7.x86_64.rpm
# 安装 docker ce
yum update -y && yum install -y \
  docker-ce-19.03.11 \
  docker-ce-cli-19.03.11
# 配置 docker
mkdir /etc/docker
cat > /etc/docker/daemon.json <<EOF
{
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m"
  },
  "storage-driver": "overlay2",
  "storage-opts": [
    "overlay2.override_kernel_check=true"
  ]
}
EOF
mkdir -p /etc/systemd/system/docker.service.d
systemctl daemon-reload
systemctl restart docker
systemctl enable docker
```
* 安装 kubeadm, kubelet and kubectl
```shell script
# 添加 kubernetes repository
cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
exclude=kubelet kubeadm kubectl
EOF
# 设置 SELinux 为 permissive 模式
setenforce 0
sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
# 安装 kubelet kubeadm kubectl
yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes
systemctl enable --now kubelet
systemctl start kubelet
```
## Kubernetes 安装
### Master 安装
* 生成初始化文件
```shell script
kubeadm config print init-defaults > kubeadm-init.yaml
```
* 修改 advertiseAddress 为本机地址 192.168.194.136
* 下载镜像
```shell script
kubeadm config images pull --config kubeadm-init.yaml
```
* 执行初始化
```shell script
kubeadm init --config kubeadm-init.yaml
# 将 kubeadm join 保存到 kubeadm-join.sh 中
cat > ~/kubeadm-join.sh <<EOF
#!/bin/bash
kubeadm join 192.168.194.136:6443 --token abcdef.0123456789abcdef \
    --discovery-token-ca-cert-hash sha256:f9a99673747d51691e2a190101548fd764b34bf2fbd5525a37cbd699ffff3c95 
EOF
```
* 配置环境, 让当前用户可以执行kubectl命令
```shell script
mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config
```
* 查看安装结果
```shell script
kubectl get node
```
![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/kubectl-get-node1.png)
* 配置网络（此处选择 Calico）
```shell script
# 获取 Calico 的 yaml 资源清单
wget https://docs.projectcalico.org/manifests/calico.yaml
# 查询 kubeadm 的 serviceSubnet （默认为：10.96.0.0/12）
cat kubeadm-init.yaml | grep serviceSubnet:
# 将 calico.yaml 中的 192.168.0.0/16 修改为查到的 serviceSubnet
# 初始化网络
kubectl apply -f calico.yaml
```
![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/calico.png)
* 查看安装结果
```shell script
kubectl get node
```
![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/kubectl-get-node2.png)

### Worker 安装
* 执行之前在 Master 上保存的 kubeadm-join.sh
![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/kubectl-get-node3.png)


