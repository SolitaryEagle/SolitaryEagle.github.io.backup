---
layout: post
title: k8s安装教程
category: k8s
tags: k8s
---
本文将以安装 一主一从 作为示例

# 安装环境
* 本机：
    * Linux eagle-telnet 5.4.0-42-generic #46-Ubuntu SMP Fri Jul 10 00:24:02 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux
    * Ubuntu 20.04.1 LTS
    ![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/Ubuntu.png)
* 虚拟机
    * VMware® Workstation 15 Pro
    ![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/VMware.png)
    * [CentOS 8](https://mirrors.aliyun.com/centos/8/isos/x86_64/CentOS-8.2.2004-x86_64-boot.iso)
* 安装工具
    * 本文采用 kubeadm 引导安装 k8s 集群

# 虚拟机安装 CentOS 
## CentOS 配置
> 两台一样配置的 CentOS 虚拟机（k8s-master, k8s-worker)
* 内存 4 g
* CPU 2 核，开启虚拟化功能
* 网络 NAT 类型（单网卡）
* 磁盘 120 GB
![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/CentOs1.png)
![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/CentOs2.png)
![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/CentOs3.png)
## CentOS 安装
> 两台机子的安装过程几乎一致
> 
> 主机的 HostName 为 k8s-master
>
> 从机的 HostName 为 k8s-worker

1. 选择语言：English
2. 设置时间：Asia/Shanghai
3. 设置网络：
    1. 打开网络连接
    2. 设置 Host Name：k8s-master
4. 软件选择：最小安装
5. 设置 root 密码
6. 关闭磁盘连接，重启
![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/CentOs4.png)
![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/CentOs5.png)
![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/_posts/k8s/CentOs6.png)
## Kubernetes 安装(使用 root 用户)
> 两台机子都需要执行的步骤（建议按顺序分别执行两次）
* 设置本地 hosts
```text
192.168.194.136 k8s-master
192.168.194.137 k8s-worker
```
* 设置 locale
```shell script
echo "export LC_ALL=en_US.UTF-8"  >>  /etc/profile 
source /etc/profile
```
* 安装基本工具
```shell script
yum update -y && yum install -y \
  vim \
  net-tools \
  bash-completion 
```
* 关闭交换分区 -- 编辑/etc/fstab, 将swap注释掉.
 ```shell script
vim /etc/fstab
```
![]()
* 检查 Mac 地址 和 product_uuid 是否唯一
```shell script
ip link
cat /sys/class/dmi/id/product_uuid
```
* 检查 br_netfilter 模块是否加载
```shell script
# 检查 br_netfilter 模块是否加载
lsmod | grep br_netfilter
# 显式加载 br_netfilter 模块
modprobe br_netfilter
```
* 使用 iptables 作为网桥
```shell script
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sysctl --system
```
* 关闭防火墙或开放 Kubernetes 需要的端口
```shell script
# 关闭防火墙
systemctl stop firewalld
systemctl disable firewalld
```

