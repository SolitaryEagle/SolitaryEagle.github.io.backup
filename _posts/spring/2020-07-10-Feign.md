---
layout: post
title: Feign
category: spring
tags: spring
---
# 参考文章
> [Feign 原理图解 - 疯狂创客圈](https://www.cnblogs.com/crazymakercircle/p/11965726.html)

Feign 组件图

![](https://raw.githubusercontent.com/OpenFeign/feign/master/src/docs/overview.png)

Feign 调用基本流程图

![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/images/Feign%20%E8%B0%83%E7%94%A8%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B%E5%9B%BE.png)

![](https://raw.githubusercontent.com/SolitaryEagle/SolitaryEagle.github.io/master/images/Feign%20%E8%B0%83%E7%94%A8%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B%E5%9B%BE2.png)

# Feign 组件
* (async)clients: 执行 http 请求的客户端
* contracts: 根据接口类的注解声明规则, 解析出底层的 MethodHandler
* encoders: 将方法参数编码为 http 请求参数
* decoders: 将 http 响应结果解码为方法返回值; ErrorDecoder -> 异常处理解码器
* metrics: 监控
# Feign 功能

# Feign 接口

## Client
执行 http 请求的客户端

## Contract
定义哪些注解和值在接口上是有效的

## Decoder

将 HTTP 响应解码为给定类型的单个对象. 

触发条件: 
* 当 Response.status() 在 2xx 范围中, 并且
* 返回值不是 void 也不是 Response

## Encoder
将对象编码为 HTTP 请求 body. 
当方法参数没有 @Param 注解时, 会使用 javax.websocket.Encoder.Encoder

## ErrorDecoder
允许将异常转换为特定于应用程序的异常, 转换输出为 throttle 的异常就是这种例子.

当 Response.status() 不在 2xx 范围中时, 被认为是 errors, 由 ErrorDecoder 处理. 
也就是说, 确定的 RPC apis 返回的 errors 定义在 Response.body() 中, 即使 status 为 200.
例如, 在 DynECT api 中, 一个 job 的运行的条件是返回的 status 是 200. 当发生这种情况时, 
你应该添加一个特定于应用程序的异常.

404 status 有一个默认的异常, 用户可以通过 feign.Feign.Builder.decode404() 改变.

## MethodHandler
方法的处理者

## RequestInterceptor
RequestInterceptor 可以对所有的 request 进行配置, 如添加 headers.
不保证以定义的顺序访问 RequestInterceptor, 一旦 RequestInterceptor 被应用, 
Target.apply(RequestTemplate) 被调用去创建 immutable 的 http request 通过
Client.execute(Request, Request.Options) 发送.

RequestInterceptor 可以通过 Feign.Builder.requestInterceptors 配置.

不要在你的实现的 apply(RequestTemplate) 中添加 parameters. 因为 RequestInterceptor
是在模板参数被解析之后应用的. 这是为了确保你可以实现 signatures 是 RequestInterceptor.

## ResponseMapper
在 response decoding 之前应用.

## Retryer
克隆每一个 Client.execute(Request, Request.Options). 实现可以保持 state 去确定 retry
操作是否应该继续.

## Target
与 javax.ws.rs.client.WebTarget 类似, 作为 requests 的生产者. 然而 RequestTemplate
更接近 WebTarget

